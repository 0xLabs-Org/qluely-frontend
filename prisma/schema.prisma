generator client {
  provider   = "prisma-client-js"
  engineType = "client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  passwordHash     String
  name             String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  lastLoginAt      DateTime?
  account          Account?
  checkoutSessions CheckoutSession[]
  invoices         Invoice[]
  payments         Payment[]
  Session          Session[]
  Subscription     Subscription[]

  @@index([email])
}

model Account {
  id               String       @id @default(cuid())
  userId           String       @unique
  type             AccountTypes @default(FREE)
  planSlug         String?
  status           String       @default("pending")
  startedAt        DateTime?
  nextBillingDate  DateTime?
  cancelledAt      DateTime?
  creditsRemaining Int          @default(15)
  creditsUsed      Int          @default(0)
  customerId       String?      @unique
  subscriptionId   String?      @unique
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices         Invoice[]
  payments         Payment[]

  @@index([userId])
  @@index([status])
  @@index([customerId])
}

model Payment {
  id             String        @id @default(cuid())
  userId         String
  accountId      String
  amount         Int
  status         String        @default("pending")
  processedAt    DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  dodoPaymentId  String?       @unique
  subscriptionId String?
  account        Account       @relation(fields: [accountId], references: [id])
  Subscription   Subscription? @relation(fields: [subscriptionId], references: [id])
  user           User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([accountId])
  @@index([status])
  @@index([dodoPaymentId])
}

model Invoice {
  id            String    @id @default(cuid())
  userId        String
  accountId     String
  invoiceNumber String    @unique
  totalAmount   Int
  status        String    @default("issued")
  issuedAt      DateTime  @default(now())
  paidAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  account       Account   @relation(fields: [accountId], references: [id])
  user          User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([accountId])
  @@index([status])
}

model WebhookEvent {
  id           String    @id @default(cuid())
  webhookId    String    @unique
  eventType    String
  status       String    @default("received")
  payload      Json
  processedAt  DateTime?
  errorMessage String?
  createdAt    DateTime  @default(now())

  @@index([eventType])
  @@index([status])
}

model CheckoutSession {
  id          String   @id @default(cuid())
  userId      String
  sessionId   String   @unique
  planSlug    String
  status      String   @default("pending")
  checkoutUrl String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
}

model Session {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscription {
  id        String    @id
  userId    String
  plan      String
  status    String    @default("pending")
  dodoSubId String?   @unique
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime
  Payment   Payment[]
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
}

enum AccountTypes {
  FREE
  PREMIUM
  PRO
}
